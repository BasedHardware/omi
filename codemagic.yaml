workflows:
  ios-prod-testflight:
    name: Release iOS to Testflight
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic_v4
    environment:
      ios_signing:
        provisioning_profiles:
          - codemagic_v4
          - codemagic_watchos_v4
        certificates:
          - codemagic_v4
      groups:
        - app_env
        - firebase
        - shorebird
      vars:
        APP_ID: 6502156163
      flutter: 3.35.3
      xcode: 16.4
      cocoapods: 1.16.2
    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: "v*-ios-cm"
          include: true
        - pattern: "v*-mobile-cm"
          include: true
    working_directory: app
    scripts:
      - name: Installing Opus
        script: |
          brew install opus
          brew install opus-tools

      - name: Set up Firebase
        script: |
          dart pub global activate flutterfire_cli

          # https://github.com/invertase/flutterfire_cli/issues/233
          echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > ./firebase_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_prod.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12 \
            --android-package-name=com.friend.ios \
            --android-out=android/app/src/prod/  \
            --ios-out=ios/Config/Prod/ \
            --service-account="./firebase_key.json" \
            --project="based-hardware" \
            --ios-target="Runner" \
            --yes

          # DEV, should remove
          echo "$FIREBASE_SERVICE_ACCOUNT_DEV_KEY" > ./firebase_dev_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_dev.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12.development \
            --android-package-name=com.friend.ios.dev \
            --android-out=android/app/src/dev/  \
            --ios-out=ios/Config/Dev/ \
            --service-account="./firebase_dev_key.json" \
            --project="based-hardware-dev" \
            --ios-target="Runner" \
            --yes

      - name: Set up App .env
        script: |
          echo OPENAI_API_KEY=$OPENAI_API_KEY >> .env
          echo INSTABUG_API_KEY=$INSTABUG_API_KEY >> .env
          echo MIXPANEL_PROJECT_TOKEN=$MIXPANEL_PROJECT_TOKEN >> .env
          echo ONESIGNAL_APP_ID=$ONESIGNAL_APP_ID >> .env
          echo API_BASE_URL=$API_BASE_URL >> .env
          echo GROWTHBOOK_API_KEY=$GROWTHBOOK_API_KEY >> .env
          echo GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY >> .env
          echo INTERCOM_APP_ID=$INTERCOM_APP_ID >> .env
          echo INTERCOM_IOS_API_KEY=$INTERCOM_IOS_API_KEY >> .env
          echo POSTHOG_API_KEY=$POSTHOG_API_KEY >> .env
          echo GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID >> .env
          echo GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET >> .env

      - name: Set up Google Service Info
        script: |
          # TODO: check why we need this ?
          echo "$GOOGLE_INFO_PLIST_KEY" > "$(pwd)/ios/Runner/GoogleService-Info.plist"

      - name: Generate iOS Custom Config (Custom.xcconfig)
        script: |
          sh scripts/generate_ios_custom_config.sh ios/Config/Prod/GoogleService-Info.plist ios/Flutter/

      - name: Get Flutter packages
        script: |
          flutter pub get

      - name: Run build runner
        script: |
          dart run build_runner build --delete-conflicting-outputs

      - name: Installs pod
        script: |
          cd ios && pod install --repo-update

      - name: Flutter build ipa
        script: |
          # Set up code signing settings on Xcode project
          # -> $HOME/export_options.plist
          xcode-project use-profiles

          # Build
          BUILD_NAME=$(echo $CM_TAG | sed 's/^v\(.*\)+\(.*\)-mobile-cm$/\1/')
          BUILD_NUMBER=$(echo $CM_TAG | sed 's/^v\(.*\)+\(.*\)-mobile-cm$/\2/')
          flutter build ipa \
            --release \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --flavor prod \
            --export-options-plist=$HOME/export_options.plist

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    publishing:
      scripts:
        - name: Upload debug symbols to Firebase Crashlytics
          script: |
            echo "Finding all debug symbol files..."

            # Find all dSYM files in the derived data directory
            dsymFiles=$(find $HOME/Library/Developer/Xcode/DerivedData -name "*.dSYM" -type d 2>/dev/null)

            if [[ -z "$dsymFiles" ]]
            then
              echo "No debug symbols were found, skip publishing to Firebase Crashlytics"
            else
              echo "Found dSYM files:"
              echo "$dsymFiles"
              echo ""

              # Find the upload-symbols script in the Pods directory
              uploadScriptPath=$(find ios/Pods/FirebaseCrashlytics -name "upload-symbols" -type f 2>/dev/null | head -1)

              if [[ -n ${uploadScriptPath} ]]
              then
                echo "Found upload-symbols script at: $uploadScriptPath"
                # Make sure it's executable
                chmod +x "$uploadScriptPath"

                # Upload each dSYM file
                echo "$dsymFiles" | while IFS= read -r dsymPath; do
                  if [[ -n "$dsymPath" ]]; then
                    echo "Uploading dSYM: $dsymPath"
                    "$uploadScriptPath" \
                      -gsp ios/Runner/GoogleService-Info.plist -p ios "$dsymPath"
                    echo "Completed upload for: $dsymPath"
                    echo ""
                  fi
                done

                echo "All dSYM files uploaded successfully"
              else
                echo "upload-symbols script not found. Skipping Firebase Crashlytics upload."
              fi
            fi
      email:
        recipients:
          - ngocthinhdp@gmail.com
          - joan@basedhardware.com
          - nik@basedhardware.com
          - mohsin.lp710@gmail.com
        notify:
          success: true
          failure: false
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - Internal
          - Discord Folks
        submit_to_app_store: false

  macos-prod-testflight:
    name: Release macOS to Testflight
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic_v4
    environment:
      groups:
        - app_env
        - firebase
        - appstore_credentials
      vars:
        APP_ID: 6502156163
        BUNDLE_ID: "com.friend-app-with-wearable.ios12"
      flutter: 3.35.3
      xcode: 26.0.1
      cocoapods: 1.16.2
    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: "v*-desktop-cm"
          include: true
    working_directory: app
    scripts:
      - name: Set up Firebase
        script: |
          dart pub global activate flutterfire_cli

          # https://github.com/invertase/flutterfire_cli/issues/233
          echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > ./firebase_key.json
          flutterfire config \
            --platforms="macos" \
            --out=lib/firebase_options_prod.dart \
            --macos-bundle-id=com.friend-app-with-wearable.ios12 \
            --macos-out=macos/Config/Prod \
            --service-account="./firebase_key.json" \
            --project="based-hardware" \
            --macos-target="Runner" \
            --yes

          # DEV, should remove
          echo "$FIREBASE_SERVICE_ACCOUNT_DEV_KEY" > ./firebase_dev_key.json
          flutterfire config \
            --platforms="macos" \
            --out=lib/firebase_options_dev.dart \
            --macos-bundle-id=com.friend-app-with-wearable.ios12.development \
            --macos-out=macos/Config/Dev/ \
            --service-account="./firebase_dev_key.json" \
            --project="based-hardware-dev" \
            --macos-target="Runner" \
            --yes

      - name: Set up Google Service Info
        script: |
          # Copy GoogleService-Info.plist
          cp macos/Config/Prod/GoogleService-Info.plist macos/GoogleService-Info.plist

      - name: Set up App .env
        script: |
          echo OPENAI_API_KEY=$OPENAI_API_KEY >> .env
          echo INSTABUG_API_KEY=$INSTABUG_API_KEY >> .env
          echo MIXPANEL_PROJECT_TOKEN=$MIXPANEL_PROJECT_TOKEN >> .env
          echo ONESIGNAL_APP_ID=$ONESIGNAL_APP_ID >> .env
          echo API_BASE_URL=$API_BASE_URL >> .env
          echo GROWTHBOOK_API_KEY=$GROWTHBOOK_API_KEY >> .env
          echo GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY >> .env
          echo INTERCOM_APP_ID=$INTERCOM_APP_ID >> .env
          echo INTERCOM_IOS_API_KEY=$INTERCOM_IOS_API_KEY >> .env
          echo POSTHOG_API_KEY=$POSTHOG_API_KEY >> .env
          echo GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID >> .env
          echo GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET >> .env

      - name: Get Flutter packages
        script: |
          flutter pub get

      - name: Run build runner
        script: |
          dart run build_runner build --delete-conflicting-outputs

      - name: Install pods
        script: |
          cd macos && pod install --repo-update

      - name: Set up keychain for code signing
        script: |
          keychain initialize

      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --platform MAC_OS \
            --type MAC_APP_STORE \
            --create

      - name: Fetch Mac Installer Distribution certificates
        script: |
          # Try to find an existing certificate with our private key
          echo "Checking for existing Mac Installer Distribution certificate with our private key..."
          if app-store-connect certificates list --type MAC_INSTALLER_DISTRIBUTION --save 2>&1 | grep -q "Saved Signing Certificate"; then
            echo "Found existing certificate with matching private key"
          else
            echo "No matching certificate found, creating new one for Codemagic..."
            app-store-connect certificates create --type MAC_INSTALLER_DISTRIBUTION --save
          fi

      - name: Add certificates to keychain
        script: |
          keychain add-certificates

      - name: Set up code signing settings
        script: |
          xcode-project use-profiles

      - name: Flutter build macOS
        script: |
          # Build
          BUILD_NAME=$(echo $CM_TAG | sed 's/^v\(.*\)+\(.*\)-desktop-cm$/\1/')
          BUILD_NUMBER=$(echo $CM_TAG | sed 's/^v\(.*\)+\(.*\)-desktop-cm$/\2/')
          flutter build macos \
            --release \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --flavor prod

      - name: Package application for App Store
        script: |
          set -x

          # Find the app bundle
          APP_NAME=$(find $(pwd) -name "Omi.app" | head -1)
          echo "Found app at: $APP_NAME"

          # Set output directory
          OUTPUT_DIR="$(pwd)/build/macos"
          mkdir -p "$OUTPUT_DIR"

          # Create unsigned package
          PACKAGE_NAME="Omi.pkg"
          xcrun productbuild --component "$APP_NAME" /Applications/ "$OUTPUT_DIR/unsigned.pkg"

          # Find the installer certificate common name in keychain
          INSTALLER_CERT_NAME=$(keychain list-certificates \
            | jq -r '.[] | select(.common_name | contains("3rd Party Mac Developer Installer")) | .common_name' \
            | head -1)

          if [ -z "$INSTALLER_CERT_NAME" ]; then
            echo "ERROR: No Mac Installer Distribution certificate found"
            echo "Available certificates:"
            keychain list-certificates | jq -r '.[].common_name'
            exit 1
          fi

          echo "Using installer certificate: $INSTALLER_CERT_NAME"

          # Sign the package
          xcrun productsign --sign "$INSTALLER_CERT_NAME" "$OUTPUT_DIR/unsigned.pkg" "$OUTPUT_DIR/$PACKAGE_NAME"

          # Clean up
          rm -f "$OUTPUT_DIR/unsigned.pkg"

          echo "Package created at: $OUTPUT_DIR/$PACKAGE_NAME"

    artifacts:
      - build/macos/*.pkg
      - build/macos/**/*.app
    publishing:
      email:
        recipients:
          - ngocthinhdp@gmail.com
          - joan@basedhardware.com
          - nik@basedhardware.com
          - mohsin.lp710@gmail.com
        notify:
          success: true
          failure: false
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        beta_groups:
          - Internal
          - Discord Folks
        submit_to_app_store: false

  android-prod-internal:
    name: Release Android Internal Production
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - prod_android_upload_keystore
      groups:
        - app_env
        - firebase
        - google_play
        - shorebird
      vars:
        PACKAGE_NAME: "com.friend.ios"
        JAVA_TOOL_OPTIONS: "-Xmx8g"
      flutter: 3.35.3
      xcode: 16.4
      cocoapods: 1.16.2
      java: 21
    cache:
      cache_paths:
        - $HOME/opt
        - $HOME/.pub-cache
        - $HOME/.gradle/caches
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: "v*-android-cm"
          include: true
        - pattern: "v*-mobile-cm"
          include: true
    working_directory: app
    scripts:
      - name: Installing Android SDK
        script: |
          export ANDROID_HOME="$HOME/opt/android-sdk"
          if [ ! -d "$ANDROID_HOME" ]; then
            echo "$ANDROID_HOME does not exist. Installing..."

            mkdir -p $ANDROID_HOME

            # Install cmdline-tools 11076708; NDK: 28.2.13676358
            cd "$HOME/opt" && \
            curl --fail --show-error --silent --connect-timeout 10.00 --max-time 120.00 \
              --output commandlinetools-mac-11076708_latest.zip \
              https://dl.google.com/android/repository/commandlinetools-mac-11076708_latest.zip && \
            7z -bd x commandlinetools-mac-11076708_latest.zip && \
            mkdir -p $ANDROID_HOME && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} "tools" && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} "cmdline-tools;latest" && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} "ndk;28.2.13676358" && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} --licenses  && \
            cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} --list
          fi

          if [ -d "$ANDROID_HOME" ]; then
            echo "$ANDROID_HOME does exist. Setting up env..."

            # PATH
            export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools

            # Override ENV
            echo ANDROID_HOME="$ANDROID_HOME" >> $CM_ENV
            echo ANDROID_SDK_ROOT="$ANDROID_HOME" >> $CM_ENV
            echo PATH="$PATH" >> $CM_ENV
          fi

      - name: Installing Opus
        script: |
          brew install opus
          brew install opus-tools

      - name: Set up Firebase
        script: |
          dart pub global activate flutterfire_cli

          # https://github.com/invertase/flutterfire_cli/issues/233
          echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > ./firebase_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_prod.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12 \
            --android-package-name=com.friend.ios \
            --android-out=android/app/src/prod/  \
            --ios-out=ios/Config/Prod/ \
            --service-account="./firebase_key.json" \
            --project="based-hardware" \
            --ios-target="Runner" \
            --yes

          # DEV, should remove
          echo "$FIREBASE_SERVICE_ACCOUNT_DEV_KEY" > ./firebase_dev_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_dev.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12.development \
            --android-package-name=com.friend.ios.dev \
            --android-out=android/app/src/dev/  \
            --ios-out=ios/Config/Dev/ \
            --service-account="./firebase_dev_key.json" \
            --project="based-hardware-dev" \
            --ios-target="Runner" \
            --yes

      - name: Set up local.properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$(pwd)/android/local.properties"
          echo "sdk.dir=$ANDROID_HOME" >> "$(pwd)/android/local.properties"

      - name: Set up App .env
        script: |
          echo OPENAI_API_KEY=$OPENAI_API_KEY >> .env
          echo INSTABUG_API_KEY=$INSTABUG_API_KEY >> .env
          echo MIXPANEL_PROJECT_TOKEN=$MIXPANEL_PROJECT_TOKEN >> .env
          echo ONESIGNAL_APP_ID=$ONESIGNAL_APP_ID >> .env
          echo API_BASE_URL=$API_BASE_URL >> .env
          echo GROWTHBOOK_API_KEY=$GROWTHBOOK_API_KEY >> .env
          echo GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY >> .env
          echo INTERCOM_APP_ID=$INTERCOM_APP_ID >> .env
          echo INTERCOM_ANDROID_API_KEY=$INTERCOM_ANDROID_API_KEY >> .env
          echo GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID >> .env
          echo GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET >> .env

      - name: Get Flutter packages
        script: |
          flutter packages pub get
      - name: Run build runner
        script: |
          dart run build_runner build --delete-conflicting-outputs
      - name: Build AAB with Flutter
        script: |
          # TODO: Don't tricky
          # Tricky Opus > build.gradle, force use NDK 28 to deal with "ERROR: Unknown host CPU architecture: arm64 and 16kb memory page size support"
          # echo "Z3JvdXAgJ2V1LmVwbncub3B1c19mbHV0dGVyX2FuZHJvaWQnDQp2ZXJzaW9uICcxLjAnDQoNCmJ1aWxkc2NyaXB0IHsNCiAgICByZXBvc2l0b3JpZXMgew0KICAgICAgICBnb29nbGUoKQ0KICAgICAgICBtYXZlbkNlbnRyYWwoKQ0KICAgIH0NCg0KICAgIGRlcGVuZGVuY2llcyB7DQogICAgICAgIGNsYXNzcGF0aCAnY29tLmFuZHJvaWQudG9vbHMuYnVpbGQ6Z3JhZGxlOjcuMy4wJw0KICAgIH0NCn0NCg0Kcm9vdFByb2plY3QuYWxscHJvamVjdHMgew0KICAgIHJlcG9zaXRvcmllcyB7DQogICAgICAgIGdvb2dsZSgpDQogICAgICAgIG1hdmVuQ2VudHJhbCgpDQogICAgfQ0KfQ0KDQphcHBseSBwbHVnaW46ICdjb20uYW5kcm9pZC5saWJyYXJ5Jw0KDQphbmRyb2lkIHsNCiAgICBpZiAocHJvamVjdC5hbmRyb2lkLmhhc1Byb3BlcnR5KCJuYW1lc3BhY2UiKSkgew0KICAgICAgICBuYW1lc3BhY2UgJ2V1LmVwbncub3B1c19mbHV0dGVyX2FuZHJvaWQnDQogICAgfQ0KDQogICAgY29tcGlsZVNka1ZlcnNpb24gMzMNCg0KICAgIGNvbXBpbGVPcHRpb25zIHsNCiAgICAgICAgc291cmNlQ29tcGF0aWJpbGl0eSBKYXZhVmVyc2lvbi5WRVJTSU9OXzFfOA0KICAgICAgICB0YXJnZXRDb21wYXRpYmlsaXR5IEphdmFWZXJzaW9uLlZFUlNJT05fMV84DQogICAgfQ0KDQogICAgZGVmYXVsdENvbmZpZyB7DQogICAgICAgIG1pblNka1ZlcnNpb24gMTkNCiAgICB9DQogICAgZXh0ZXJuYWxOYXRpdmVCdWlsZCB7DQogICAgICAgIG5ka0J1aWxkew0KICAgICAgICAgICAgcGF0aCAiQW5kcm9pZC5tayINCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGRlcGVuZGVuY2llcyB7DQogICAgICAgIHRlc3RJbXBsZW1lbnRhdGlvbiAnanVuaXQ6anVuaXQ6NC4xMy4yJw0KICAgICAgICB0ZXN0SW1wbGVtZW50YXRpb24gJ29yZy5tb2NraXRvOm1vY2tpdG8tY29yZTo1LjAuMCcNCiAgICB9DQoNCiAgICB0ZXN0T3B0aW9ucyB7DQogICAgICAgIHVuaXRUZXN0cy5hbGwgew0KICAgICAgICAgICAgdGVzdExvZ2dpbmcgew0KICAgICAgICAgICAgICAgZXZlbnRzICJwYXNzZWQiLCAic2tpcHBlZCIsICJmYWlsZWQiLCAic3RhbmRhcmRPdXQiLCAic3RhbmRhcmRFcnJvciINCiAgICAgICAgICAgICAgIG91dHB1dHMudXBUb0RhdGVXaGVuIHtmYWxzZX0NCiAgICAgICAgICAgICAgIHNob3dTdGFuZGFyZFN0cmVhbXMgPSB0cnVlDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgbmRrVmVyc2lvbiAnMjcuMC4xMjA3Nzk3MycNCn0NCg==" | base64 -d > "$HOME/.pub-cache/hosted/pub.dev/opus_flutter_android-3.0.1/android/build.gradle"

          # Should use bump version automatically by CI
          BUILD_NAME=$(echo $CM_TAG | sed 's/^v\(.*\)+\(.*\)-mobile-cm$/\1/')
          BUILD_NUMBER=$(echo $CM_TAG | sed 's/^v\(.*\)+\(.*\)-mobile-cm$/\2/')
          flutter build appbundle \
            --release \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --flavor prod


    artifacts:
      - build/**/outputs/**/*.aab
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - ngocthinhdp@gmail.com
          - joan@basedhardware.com
          - nik@basedhardware.com
          - mohsin.lp710@gmail.com
        notify:
          success: true
          failure: false
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: "internal"
        submit_as_draft: false
        release_promotion:
          track: "alpha"

  ios-prod-patch:
    name: Patch iOS to Production
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic_v4
    environment:
      ios_signing:
        provisioning_profiles:
          - codemagic_v4
          - codemagic_watchos_v4
        certificates:
          - codemagic_v4
      groups:
        - app_env
        - firebase
        - shorebird
      vars:
        APP_ID: 6502156163
      flutter: 3.35.3
      xcode: 16.4
      cocoapods: 1.16.2
    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $HOME/.gradle/caches
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: "v*-ios-patch-cm"
          include: true
        - pattern: "v*-mobile-patch-cm"
          include: true
    working_directory: app
    scripts:
      - name: Installing Shorebird
        script: |
          # Install the Shorebird CLI
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          # Set Shorebird PATH
          echo PATH="/Users/builder/.shorebird/bin:$PATH" >> $CM_ENV

      - name: Installing Opus
        script: |
          brew install opus
          brew install opus-tools

      - name: Set up Firebase
        script: |
          dart pub global activate flutterfire_cli

          # https://github.com/invertase/flutterfire_cli/issues/233
          echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > ./firebase_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_prod.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12 \
            --android-package-name=com.friend.ios \
            --android-out=android/app/src/prod/  \
            --ios-out=ios/Config/Prod/ \
            --service-account="./firebase_key.json" \
            --project="based-hardware" \
            --ios-target="Runner" \
            --yes

          # DEV, should remove
          echo "$FIREBASE_SERVICE_ACCOUNT_DEV_KEY" > ./firebase_dev_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_dev.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12.development \
            --android-package-name=com.friend.ios.dev \
            --android-out=android/app/src/dev/  \
            --ios-out=ios/Config/Dev/ \
            --service-account="./firebase_dev_key.json" \
            --project="based-hardware-dev" \
            --ios-target="Runner" \
            --yes

      - name: Set up App .env
        script: |
          echo OPENAI_API_KEY=$OPENAI_API_KEY >> .env
          echo INSTABUG_API_KEY=$INSTABUG_API_KEY >> .env
          echo MIXPANEL_PROJECT_TOKEN=$MIXPANEL_PROJECT_TOKEN >> .env
          echo ONESIGNAL_APP_ID=$ONESIGNAL_APP_ID >> .env
          echo API_BASE_URL=$API_BASE_URL >> .env
          echo GROWTHBOOK_API_KEY=$GROWTHBOOK_API_KEY >> .env
          echo GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY >> .env
          echo INTERCOM_APP_ID=$INTERCOM_APP_ID >> .env
          echo INTERCOM_IOS_API_KEY=$INTERCOM_IOS_API_KEY >> .env
          echo POSTHOG_API_KEY=$POSTHOG_API_KEY >> .env
          echo GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID >> .env
          echo GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET >> .env

      - name: Set up Google Service Info
        script: |
          # TODO: check why we need this ?
          echo "$GOOGLE_INFO_PLIST_KEY" > "$(pwd)/ios/Runner/GoogleService-Info.plist"

      - name: Get Flutter packages
        script: |
          flutter pub get

      - name: Run build runner
        script: |
          dart run build_runner build --delete-conflicting-outputs

      - name: Installs pod
        script: |
          cd ios && pod install --repo-update

      - name: Patch iOS app with Shorebird
        script: |
          # Set up code signing settings on Xcode project
          # -> $HOME/export_options.plist
          xcode-project use-profiles

          # Build
          shorebird patch ios \
            --flavor prod -- \
            --export-options-plist=$HOME/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - ngocthinhdp@gmail.com
          - joan@basedhardware.com
          - nik@basedhardware.com
          - mohsin.lp710@gmail.com
        notify:
          success: true
          failure: false

  macos-desktop-release:
    name: Release macOS Desktop Update (DMG)
    instance_type: mac_mini_m2
    max_build_duration: 120
    integrations:
      app_store_connect: codemagic_v4
    environment:
      groups:
        - app_env
        - firebase
        - google_play
        - appstore_credentials
      vars:
        GCS_BUCKET: "gs://omi_macos_updates"
        PLATFORM: "macos"
        BUNDLE_ID: "com.friend-app-with-wearable.ios12"
      flutter: 3.35.3
      xcode: 26.0.1
      cocoapods: 1.16.2
    cache:
      cache_paths:
        - $HOME/.pub-cache
        - $HOME/Library/Caches/CocoaPods
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: "v*-desktop-cm"
          include: true
        - pattern: "v*-macos-cm"
          include: true
    working_directory: app
    scripts:
      - name: Set up Firebase
        script: |
          dart pub global activate flutterfire_cli

          # https://github.com/invertase/flutterfire_cli/issues/233
          echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > ./firebase_key.json
          flutterfire config \
            --platforms="macos" \
            --out=lib/firebase_options_prod.dart \
            --macos-bundle-id=com.friend-app-with-wearable.ios12 \
            --macos-out=macos/Config/Prod \
            --service-account="./firebase_key.json" \
            --project="based-hardware" \
            --macos-target="Runner" \
            --yes

          # DEV, should remove
          echo "$FIREBASE_SERVICE_ACCOUNT_DEV_KEY" > ./firebase_dev_key.json
          flutterfire config \
            --platforms="macos" \
            --out=lib/firebase_options_dev.dart \
            --macos-bundle-id=com.friend-app-with-wearable.ios12.development \
            --macos-out=macos/Config/Dev/ \
            --service-account="./firebase_dev_key.json" \
            --project="based-hardware-dev" \
            --macos-target="Runner" \
            --yes

      - name: Set up Google Service Info
        script: |
          # Copy GoogleService-Info.plist
          cp macos/Config/Prod/GoogleService-Info.plist macos/GoogleService-Info.plist

      - name: Set up App .env
        script: |
          echo OPENAI_API_KEY=$OPENAI_API_KEY >> .env
          echo INSTABUG_API_KEY=$INSTABUG_API_KEY >> .env
          echo MIXPANEL_PROJECT_TOKEN=$MIXPANEL_PROJECT_TOKEN >> .env
          echo ONESIGNAL_APP_ID=$ONESIGNAL_APP_ID >> .env
          echo API_BASE_URL=$API_BASE_URL >> .env
          echo GROWTHBOOK_API_KEY=$GROWTHBOOK_API_KEY >> .env
          echo GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY >> .env
          echo INTERCOM_APP_ID=$INTERCOM_APP_ID >> .env
          echo INTERCOM_IOS_API_KEY=$INTERCOM_IOS_API_KEY >> .env
          echo POSTHOG_API_KEY=$POSTHOG_API_KEY >> .env
          echo GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID >> .env
          echo GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET >> .env

      - name: Extract version from tag
        script: |
          # TESTING: Hardcoded version
          BUILD_NAME="1.0.78"
          BUILD_NUMBER="474"

          # Extract version from tag (supports both -desktop-cm and -macos-cm)
          # BUILD_NAME=$(echo $CM_TAG | sed -E 's/^v([0-9.]+)\+([0-9]+)-(desktop|macos)-cm$/\1/')
          # BUILD_NUMBER=$(echo $CM_TAG | sed -E 's/^v([0-9.]+)\+([0-9]+)-(desktop|macos)-cm$/\2/')

          # Export to environment for all subsequent steps
          echo BUILD_NAME="$BUILD_NAME" >> $CM_ENV
          echo BUILD_NUMBER="$BUILD_NUMBER" >> $CM_ENV
          echo VERSION="${BUILD_NAME}+${BUILD_NUMBER}" >> $CM_ENV

          echo "Version set to: ${BUILD_NAME}+${BUILD_NUMBER}"

      - name: Get Flutter packages
        script: |
          flutter pub get

      - name: Run build runner
        script: |
          dart run build_runner build --delete-conflicting-outputs

      - name: Install pods
        script: |
          cd macos && pod install --repo-update

      - name: Set up keychain for code signing
        script: |
          keychain initialize

      - name: Fetch Mac App Store signing files (for build)
        script: |
          # Use Mac App Store profile to build (satisfies Xcode capability requirements)
          # We'll re-sign with Developer ID afterwards for DMG distribution
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --platform MAC_OS \
            --type MAC_APP_STORE \
            --create

      - name: Verify Developer ID provisioning profile
        script: |
          # Codemagic should have already installed the uploaded provisioning profile
          echo "Checking for available provisioning profiles..."
          ls -la "$HOME/Library/MobileDevice/Provisioning Profiles/" || echo "No profiles directory found"

          # List all profiles to verify mac_dmg_v1 was installed
          if [ -d "$HOME/Library/MobileDevice/Provisioning Profiles/" ]; then
            echo "Available provisioning profiles:"
            find "$HOME/Library/MobileDevice/Provisioning Profiles/" -name "*.provisionprofile" -exec basename {} \;
          fi

      - name: Add certificates to keychain
        script: |
          keychain add-certificates

      - name: Import Developer ID certificate (for re-signing)
        script: |
          # Import Developer ID Application certificate for DMG distribution
          # This cert is used to re-sign the app after building
          
          if [ -n "$MACOS_DEVELOPER_ID_P12" ]; then
            echo "Importing Developer ID Application certificate..."
            echo "$MACOS_DEVELOPER_ID_P12" | base64 --decode > /tmp/developer_id.p12
            
            KEYCHAIN_PATH=$(keychain get-default)
            security import /tmp/developer_id.p12 \
              -k "$KEYCHAIN_PATH" \
              -P "${MACOS_DEVELOPER_ID_P12_PASSWORD:-}" \
              -T /usr/bin/codesign \
              -T /usr/bin/security
            
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" "$KEYCHAIN_PATH" 2>/dev/null || true
            
            rm /tmp/developer_id.p12
            echo "Developer ID certificate imported successfully"
          else
            echo "ERROR: MACOS_DEVELOPER_ID_P12 environment variable not set"
            echo "Please add your Developer ID Application certificate as base64 to the appstore_credentials group"
            exit 1
          fi
          
          # Find and export the Developer ID cert name for later
          DEVELOPER_ID_CERT=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | awk -F'"' '{print $2}')
          echo "Found Developer ID cert: $DEVELOPER_ID_CERT"
          echo "DEVELOPER_ID_CERT=$DEVELOPER_ID_CERT" >> $CM_ENV

      - name: Set up code signing settings
        script: |
          xcode-project use-profiles

      - name: Flutter build macOS
        script: |
          echo "Building version: $BUILD_NAME+$BUILD_NUMBER"

          # Build with Mac App Store signing (satisfies Xcode requirements)
          flutter build macos \
            --release \
            --build-name=$BUILD_NAME \
            --build-number=$BUILD_NUMBER \
            --flavor prod

      - name: Re-sign app with Developer ID
        script: |
          # Find the app bundle (built with Mac App Store signing)
          APP_PATH=$(find $(pwd)/build/macos -name "Omi.app" -type d | head -1)
          echo "Found app at: $APP_PATH"
          
          if [ -z "$APP_PATH" ]; then
            echo "ERROR: Could not find Omi.app"
            find $(pwd)/build/macos -type d -name "*.app"
            exit 1
          fi
          
          echo "Re-signing with Developer ID: $DEVELOPER_ID_CERT"

          # CRITICAL: Replace Mac App Store profile with Developer ID profile
          echo "Removing Mac App Store provisioning profile..."
          rm -f "$APP_PATH/Contents/embedded.provisionprofile"

          # Find and embed Developer ID provisioning profile
          echo "Finding Developer ID provisioning profile..."

          # List all available profiles for debugging
          echo "Available provisioning profiles:"
          find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.provisionprofile" -type f 2>/dev/null | while read profile; do
            echo "  Profile: $(basename "$profile")"
            /usr/libexec/PlistBuddy -c "Print :Name" "$profile" 2>/dev/null | head -1 || echo "  (could not read name)"
          done

          # Search for Developer ID profile (try multiple methods)
          DEVELOPER_ID_PROFILE=""

          # Method 1: Search for ProvisionsAllDevices (Developer ID profiles provision all devices)
          DEVELOPER_ID_PROFILE=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.provisionprofile" -type f | while read profile; do
            if /usr/libexec/PlistBuddy -c "Print :ProvisionsAllDevices" "$profile" 2>/dev/null | grep -q "true"; then
              # Verify it's for our bundle ID
              PROFILE_APP_ID=$(/usr/libexec/PlistBuddy -c "Print :Entitlements:com.apple.application-identifier" "$profile" 2>/dev/null)
              if [[ "$PROFILE_APP_ID" == *"$BUNDLE_ID"* ]]; then
                echo "$profile"
                break
              fi
            fi
          done)

          # Method 2: If not found, try searching by Name or get the newest one
          if [ -z "$DEVELOPER_ID_PROFILE" ]; then
            DEVELOPER_ID_PROFILE=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.provisionprofile" -type f -print0 | xargs -0 ls -t | head -1)
          fi

          if [ -n "$DEVELOPER_ID_PROFILE" ]; then
            echo "Found Developer ID profile: $DEVELOPER_ID_PROFILE"
            echo "Profile details:"
            /usr/libexec/PlistBuddy -c "Print :Name" "$DEVELOPER_ID_PROFILE" 2>/dev/null || echo "  (no name)"
            /usr/libexec/PlistBuddy -c "Print :TeamName" "$DEVELOPER_ID_PROFILE" 2>/dev/null || echo "  (no team)"

            echo "Embedding Developer ID profile into app bundle..."
            cp "$DEVELOPER_ID_PROFILE" "$APP_PATH/Contents/embedded.provisionprofile"
            echo "Profile embedded successfully"
          else
            echo "WARNING: No Developer ID provisioning profile found, continuing without profile"
            echo "This may cause entitlement validation to fail!"
          fi

          # Find the Release entitlements file
          ORIGINAL_ENTITLEMENTS=$(find $(pwd)/macos/Runner -name "Release.entitlements" | head -1)
          if [ -z "$ORIGINAL_ENTITLEMENTS" ]; then
            ORIGINAL_ENTITLEMENTS=$(find $(pwd)/macos -name "*.entitlements" | head -1)
          fi

          # Create a clean entitlements file for Developer ID
          # Developer ID apps need real Team ID values, not $(AppIdentifierPrefix) placeholders
          ENTITLEMENTS_FILE="/tmp/DeveloperID.entitlements"
          TEAM_ID="9536L8KLMP"
          BUNDLE_ID="com.friend-app-with-wearable.ios12"

          if [ -n "$ORIGINAL_ENTITLEMENTS" ]; then
            echo "Original entitlements: $ORIGINAL_ENTITLEMENTS"
            cp "$ORIGINAL_ENTITLEMENTS" "$ENTITLEMENTS_FILE"

            # Remove App Store-only entitlements
            /usr/libexec/PlistBuddy -c "Delete :com.apple.security.app-sandbox" "$ENTITLEMENTS_FILE" 2>/dev/null || true
            /usr/libexec/PlistBuddy -c "Delete :com.apple.developer.applesignin" "$ENTITLEMENTS_FILE" 2>/dev/null || true

            # Add required Developer ID entitlements
            /usr/libexec/PlistBuddy -c "Add :com.apple.application-identifier string ${TEAM_ID}.${BUNDLE_ID}" "$ENTITLEMENTS_FILE" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :com.apple.application-identifier ${TEAM_ID}.${BUNDLE_ID}" "$ENTITLEMENTS_FILE"

            /usr/libexec/PlistBuddy -c "Add :com.apple.developer.team-identifier string ${TEAM_ID}" "$ENTITLEMENTS_FILE" 2>/dev/null || \
            /usr/libexec/PlistBuddy -c "Set :com.apple.developer.team-identifier ${TEAM_ID}" "$ENTITLEMENTS_FILE"

            # Replace $(AppIdentifierPrefix) placeholders in keychain-access-groups with real Team ID
            # First, get the count of items in the array
            KEYCHAIN_COUNT=$(/usr/libexec/PlistBuddy -c "Print :keychain-access-groups" "$ENTITLEMENTS_FILE" 2>/dev/null | grep -c "^    " || echo "0")

            if [ "$KEYCHAIN_COUNT" != "0" ]; then
              # Delete the old array
              /usr/libexec/PlistBuddy -c "Delete :keychain-access-groups" "$ENTITLEMENTS_FILE" 2>/dev/null || true
              # Add new array with resolved values
              /usr/libexec/PlistBuddy -c "Add :keychain-access-groups array" "$ENTITLEMENTS_FILE"
              /usr/libexec/PlistBuddy -c "Add :keychain-access-groups:0 string ${TEAM_ID}.com.google.GIDSignIn" "$ENTITLEMENTS_FILE"
              /usr/libexec/PlistBuddy -c "Add :keychain-access-groups:1 string ${TEAM_ID}.${BUNDLE_ID}" "$ENTITLEMENTS_FILE"
            fi

            echo "Cleaned entitlements for Developer ID distribution:"
            cat "$ENTITLEMENTS_FILE"
          else
            echo "WARNING: No entitlements file found, signing without entitlements"
            ENTITLEMENTS_FILE=""
          fi
          
          # Re-sign with Developer ID - sign from inside-out (frameworks first, then app)
          # DO NOT use --deep flag as it breaks nested signatures
          # --force removes existing signature and applies new one
          # --options runtime enables hardened runtime (required for notarization)
          # --timestamp adds secure timestamp (required for notarization)

          echo "Re-signing nested frameworks with Developer ID..."
          # Find and sign all nested frameworks from innermost to outermost
          find "$APP_PATH/Contents/Frameworks" -name "*.framework" -type d -depth | while read framework; do
            echo "Signing framework: $(basename "$framework")"
            codesign --force --options runtime --timestamp \
              --sign "$DEVELOPER_ID_CERT" \
              "$framework" || echo "Warning: Failed to sign $framework"
          done

          echo "Re-signing main app bundle with Developer ID..."
          if [ -n "$ENTITLEMENTS_FILE" ]; then
            codesign --force --options runtime --timestamp \
              --entitlements "$ENTITLEMENTS_FILE" \
              --sign "$DEVELOPER_ID_CERT" \
              "$APP_PATH"
          else
            echo "ERROR: No entitlements file found - app will not have entitlements!"
            codesign --force --options runtime --timestamp \
              --sign "$DEVELOPER_ID_CERT" \
              "$APP_PATH"
          fi

          # Verify the signature
          echo "Verifying signature..."
          codesign --verify --strict --verbose=2 "$APP_PATH"
          codesign -dv --verbose=4 "$APP_PATH"

          echo "App re-signed successfully with Developer ID"

      - name: Package app for notarization
        script: |
          # Find the app bundle
          APP_PATH=$(find $(pwd)/build/macos -name "Omi.app" -type d | head -1)
          echo "Found app at: $APP_PATH"

          # Create a zip archive for notarization
          APP_ZIP="build/macos/Omi.zip"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$APP_ZIP"
          echo "Created zip for notarization: $APP_ZIP"

      - name: Notarize app
        script: |
          set -e  # Exit on error

          echo "=== Starting App Notarization ==="
          APP_ZIP="build/macos/Omi.zip"
          echo "App ZIP: $APP_ZIP"
          ls -lh "$APP_ZIP"

          echo ""
          echo "=== App Store Connect Credentials ==="
          echo "Key ID: $APP_STORE_CONNECT_KEY_IDENTIFIER"
          echo "Issuer ID: $APP_STORE_CONNECT_ISSUER_ID"
          echo "Private Key variable type: $(if [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == /* ]] || [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == @file:* ]]; then echo "File Path"; else echo "Content"; fi)"

          # Check if APP_STORE_CONNECT_PRIVATE_KEY is a file path or content
          if [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == /* ]] || [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == @file:* ]]; then
            # It's a file path reference
            PRIVATE_KEY_PATH="${APP_STORE_CONNECT_PRIVATE_KEY#@file:}"
            echo "Using existing private key from: $PRIVATE_KEY_PATH"
            if [ -f "$PRIVATE_KEY_PATH" ]; then
              echo "✓ Private key file exists"
              ls -lh "$PRIVATE_KEY_PATH"
            else
              echo "✗ ERROR: Private key file not found at $PRIVATE_KEY_PATH"
              exit 1
            fi
          else
            # It's the actual key content, write to file
            mkdir -p ~/private_keys
            PRIVATE_KEY_PATH=~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_IDENTIFIER}.p8
            echo -e "$APP_STORE_CONNECT_PRIVATE_KEY" > "$PRIVATE_KEY_PATH"
            echo "Created private key file at: $PRIVATE_KEY_PATH"
            ls -lh "$PRIVATE_KEY_PATH"
            echo "First 2 lines of key file:"
            head -n 2 "$PRIVATE_KEY_PATH"
          fi

          echo ""
          echo "=== Submitting to Apple Notary Service ==="
          RESULT=$(xcrun notarytool submit "$APP_ZIP" \
            --key "$PRIVATE_KEY_PATH" \
            --key-id "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
            --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --wait \
            --output-format json)
          
          echo "Notarization result:"
          echo "$RESULT"
          
          SUBMISSION_ID=$(echo "$RESULT" | jq -r '.id')
          STATUS=$(echo "$RESULT" | jq -r '.status')
          
          echo "Submission ID: $SUBMISSION_ID"
          echo "Status: $STATUS"
          
          if [ "$STATUS" != "Accepted" ]; then
            echo ""
            echo "=== Notarization Failed - Fetching Detailed Log ==="
            xcrun notarytool log "$SUBMISSION_ID" \
              --key "$PRIVATE_KEY_PATH" \
              --key-id "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
              --issuer "$APP_STORE_CONNECT_ISSUER_ID"
            exit 1
          fi

          echo ""
          echo "=== Stapling Notarization Ticket ==="
          APP_PATH=$(find $(pwd)/build/macos -name "Omi.app" -type d | head -1)
          echo "App path: $APP_PATH"
          xcrun stapler staple "$APP_PATH"

          echo ""
          echo "=== Verifying Notarization ==="
          spctl -a -vv -t install "$APP_PATH"

          echo ""
          echo "✓ App notarization complete!"

      - name: Create DMG installer
        script: |
          echo "Creating DMG for version: $VERSION"

          # Find the signed app bundle
          APP_PATH=$(find $(pwd)/build/macos -name "Omi.app" -type d | head -1)
          echo "Found app at: $APP_PATH"

          # Create DMG output directory
          mkdir -p build/macos/dmg

          # Create DMG using hdiutil
          DMG_NAME="Omi-${VERSION}.dmg"
          DMG_PATH="build/macos/dmg/${DMG_NAME}"

          echo "Creating DMG: $DMG_NAME"

          # Create a temporary directory for DMG contents
          TMP_DMG_DIR=$(mktemp -d)
          cp -R "$APP_PATH" "$TMP_DMG_DIR/"

          # Create DMG
          hdiutil create -volname "Omi ${VERSION}" \
            -srcfolder "$TMP_DMG_DIR" \
            -ov -format UDZO \
            "$DMG_PATH"

          # Clean up
          rm -rf "$TMP_DMG_DIR"

          # Sign the DMG with Developer ID
          echo "Signing DMG with Developer ID..."
          codesign --force --sign "$DEVELOPER_ID_CERT" "$DMG_PATH"
          
          # Verify DMG signature
          echo "Verifying DMG signature..."
          codesign --verify --verbose "$DMG_PATH"

          echo "DMG created and signed at: $DMG_PATH"
          ls -lh "$DMG_PATH"

      - name: Notarize DMG
        script: |
          set -e  # Exit on error

          echo "=== Starting DMG Notarization ==="
          DMG_PATH=$(find build/macos/dmg -name "Omi-*.dmg" | head -1)
          echo "DMG Path: $DMG_PATH"
          ls -lh "$DMG_PATH"

          echo ""
          echo "=== App Store Connect Credentials ==="
          echo "Key ID: $APP_STORE_CONNECT_KEY_IDENTIFIER"
          echo "Issuer ID: $APP_STORE_CONNECT_ISSUER_ID"
          echo "Private Key variable type: $(if [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == /* ]] || [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == @file:* ]]; then echo "File Path"; else echo "Content"; fi)"

          # Check if APP_STORE_CONNECT_PRIVATE_KEY is a file path or content
          if [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == /* ]] || [[ "$APP_STORE_CONNECT_PRIVATE_KEY" == @file:* ]]; then
            # It's a file path reference
            PRIVATE_KEY_PATH="${APP_STORE_CONNECT_PRIVATE_KEY#@file:}"
            echo "Using existing private key from: $PRIVATE_KEY_PATH"
            if [ -f "$PRIVATE_KEY_PATH" ]; then
              echo "✓ Private key file exists"
              ls -lh "$PRIVATE_KEY_PATH"
            else
              echo "✗ ERROR: Private key file not found at $PRIVATE_KEY_PATH"
              exit 1
            fi
          else
            # It's the actual key content, write to file
            mkdir -p ~/private_keys
            PRIVATE_KEY_PATH=~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_IDENTIFIER}.p8
            echo -e "$APP_STORE_CONNECT_PRIVATE_KEY" > "$PRIVATE_KEY_PATH"
            echo "Created private key file at: $PRIVATE_KEY_PATH"
            ls -lh "$PRIVATE_KEY_PATH"
            echo "First 2 lines of key file:"
            head -n 2 "$PRIVATE_KEY_PATH"
          fi

          echo ""
          echo "=== Submitting to Apple Notary Service ==="
          RESULT=$(xcrun notarytool submit "$DMG_PATH" \
            --key "$PRIVATE_KEY_PATH" \
            --key-id "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
            --issuer "$APP_STORE_CONNECT_ISSUER_ID" \
            --wait \
            --output-format json)
          
          echo "Notarization result:"
          echo "$RESULT"
          
          SUBMISSION_ID=$(echo "$RESULT" | jq -r '.id')
          STATUS=$(echo "$RESULT" | jq -r '.status')
          
          echo "Submission ID: $SUBMISSION_ID"
          echo "Status: $STATUS"
          
          if [ "$STATUS" != "Accepted" ]; then
            echo ""
            echo "=== DMG Notarization Failed - Fetching Detailed Log ==="
            xcrun notarytool log "$SUBMISSION_ID" \
              --key "$PRIVATE_KEY_PATH" \
              --key-id "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
              --issuer "$APP_STORE_CONNECT_ISSUER_ID"
            exit 1
          fi

          echo ""
          echo "=== Stapling Notarization Ticket ==="
          xcrun stapler staple "$DMG_PATH"

          echo ""
          echo "=== Verifying DMG Notarization ==="
          spctl -a -vv -t install "$DMG_PATH"

          echo ""
          echo "✓ DMG notarization complete!"
          echo "DMG is fully signed and notarized: $DMG_PATH"

      - name: Generate desktop_updater release files
        script: |
          echo "Generating desktop_updater release files for macOS..."
          dart run desktop_updater:release macos

      - name: Create desktop_updater archive
        script: |
          echo "Creating desktop_updater archive..."
          dart run desktop_updater:archive macos

          # List the generated files
          echo "Generated files in dist/:"
          ls -lh dist/

      - name: Set up Google Cloud SDK
        script: |
          # Install gcloud if not already installed
          if ! command -v gcloud &> /dev/null; then
            echo "Installing Google Cloud SDK..."
            curl https://sdk.cloud.google.com | bash
            exec -l $SHELL
            source $HOME/google-cloud-sdk/path.bash.inc
          fi

          # Authenticate with service account (reuse Play Store credentials)
          echo "$GCLOUD_SERVICE_ACCOUNT_CREDENTIALS" > /tmp/gcp-key.json
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json

          echo "GCloud authenticated successfully"

      - name: Upload to Google Cloud Storage
        script: |
          FOLDER_NAME="${VERSION}-${PLATFORM}"

          echo "Uploading $FOLDER_NAME to GCS bucket: $GCS_BUCKET"

          # Upload the entire folder
          gsutil -m cp -r "dist/${FOLDER_NAME}" "${GCS_BUCKET}/"

          # Verify upload
          echo "Verifying upload..."
          gsutil ls "${GCS_BUCKET}/${FOLDER_NAME}/"

          # Make files publicly accessible
          echo "Setting public read permissions..."
          gsutil -m acl ch -r -u AllUsers:R "${GCS_BUCKET}/${FOLDER_NAME}"

          echo "Upload complete! Files available at: https://storage.googleapis.com/omi_macos_updates/${FOLDER_NAME}/"

      - name: Create GitHub Release
        script: |
          echo "Creating GitHub release for version: $VERSION"

          # Get the recent commits for changelog
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CM_TAG^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"* %s" $PREVIOUS_TAG..$CM_TAG | grep -v "Merge" | head -20)
          else
            CHANGELOG=$(git log --pretty=format:"* %s" -10 | grep -v "Merge")
          fi

          # Create release notes
          cat > /tmp/release_notes.md <<EOF
          ## What's Changed

          $CHANGELOG

          **Full Changelog**: https://github.com/BasedHardware/omi/compare/${PREVIOUS_TAG}...${CM_TAG}

          <!-- KEY_VALUE_START
          changelog: macOS desktop app update | Bug fixes and improvements | Performance enhancements
          mandatory: false
          minimum_app_version: 1.0.70
          KEY_VALUE_END -->
          EOF

          # Find the DMG file
          DMG_FILE=$(find build/macos/dmg -name "Omi-*.dmg" | head -1)

          # Create GitHub release with DMG attachment
          echo "Creating GitHub release for $CM_TAG..."
          if [ -f "$DMG_FILE" ]; then
            echo "Uploading DMG file: $DMG_FILE"
            gh release create "$CM_TAG" \
              --title "Omi Desktop v${BUILD_NAME} (${BUILD_NUMBER})" \
              --notes-file /tmp/release_notes.md \
              --repo BasedHardware/omi \
              "$DMG_FILE"
          else
            echo "Warning: DMG file not found, creating release without DMG"
            gh release create "$CM_TAG" \
              --title "Omi Desktop v${BUILD_NAME} (${BUILD_NUMBER})" \
              --notes-file /tmp/release_notes.md \
              --repo BasedHardware/omi
          fi

          echo "GitHub release created successfully!"

    artifacts:
      - dist/**/*
      - build/macos/**/*.app
      - build/macos/dmg/*.dmg
    publishing:
      email:
        recipients:
          - ngocthinhdp@gmail.com
          - joan@basedhardware.com
          - nik@basedhardware.com
          - mohsin.lp710@gmail.com
        notify:
          success: false
          failure: false

  android-prod-patch:
    name: Patch Android to Production
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      android_signing:
        - prod_android_upload_keystore
      groups:
        - app_env
        - firebase
        - shorebird
      vars:
        PACKAGE_NAME: "com.friend.ios"
      flutter: 3.35.3
      xcode: 16.4
      cocoapods: 1.16.2
      java: 21
    cache:
      cache_paths:
        - $HOME/opt
        - $HOME/.pub-cache
        - $HOME/.gradle/caches
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: "v*-android-patch-cm"
          include: true
        - pattern: "v*-mobile-patch-cm"
          include: true
    working_directory: app
    scripts:
      - name: Installing Shorebird
        script: |
          # Install the Shorebird CLI
          curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
          # Set Shorebird PATH
          echo PATH="/Users/builder/.shorebird/bin:$PATH" >> $CM_ENV

      - name: Installing Android SDK
        script: |
          export ANDROID_HOME="$HOME/opt/android-sdk"
          if [ ! -d "$ANDROID_HOME" ]; then
            echo "$ANDROID_HOME does not exist. Installing..."

            mkdir -p $ANDROID_HOME

            # Install cmdline-tools 11076708; NDK: 28.2.13676358
            cd "$HOME/opt" && \
            curl --fail --show-error --silent --connect-timeout 10.00 --max-time 120.00 \
              --output commandlinetools-mac-11076708_latest.zip \
              https://dl.google.com/android/repository/commandlinetools-mac-11076708_latest.zip && \
            7z -bd x commandlinetools-mac-11076708_latest.zip && \
            mkdir -p $ANDROID_HOME && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} "tools" && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} "cmdline-tools;latest" && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} "ndk;28.2.13676358" && \
            yes | cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} --licenses  && \
            cmdline-tools/bin/sdkmanager --sdk_root=${ANDROID_HOME} --list
          fi

          if [ -d "$ANDROID_HOME" ]; then
            echo "$ANDROID_HOME does exist. Setting up env..."

            # PATH
            export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools

            # Override ENV
            echo ANDROID_HOME="$ANDROID_HOME" >> $CM_ENV
            echo ANDROID_SDK_ROOT="$ANDROID_HOME" >> $CM_ENV
            echo PATH="$PATH" >> $CM_ENV
          fi

      - name: Installing Opus
        script: |
          brew install opus
          brew install opus-tools

      - name: Set up Firebase
        script: |
          dart pub global activate flutterfire_cli

          # https://github.com/invertase/flutterfire_cli/issues/233
          echo "$FIREBASE_SERVICE_ACCOUNT_KEY" > ./firebase_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_prod.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12 \
            --android-package-name=com.friend.ios \
            --android-out=android/app/src/prod/  \
            --ios-out=ios/Config/Prod/ \
            --service-account="./firebase_key.json" \
            --project="based-hardware" \
            --ios-target="Runner" \
            --yes

          # DEV, should remove
          echo "$FIREBASE_SERVICE_ACCOUNT_DEV_KEY" > ./firebase_dev_key.json
          flutterfire config \
            --platforms="android,ios" \
            --out=lib/firebase_options_dev.dart \
            --ios-bundle-id=com.friend-app-with-wearable.ios12.development \
            --android-package-name=com.friend.ios.dev \
            --android-out=android/app/src/dev/  \
            --ios-out=ios/Config/Dev/ \
            --service-account="./firebase_dev_key.json" \
            --project="based-hardware-dev" \
            --ios-target="Runner" \
            --yes

      - name: Set up local.properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$(pwd)/android/local.properties"
          echo "sdk.dir=$ANDROID_HOME" >> "$(pwd)/android/local.properties"

      - name: Set up App .env
        script: |
          echo OPENAI_API_KEY=$OPENAI_API_KEY >> .env
          echo INSTABUG_API_KEY=$INSTABUG_API_KEY >> .env
          echo MIXPANEL_PROJECT_TOKEN=$MIXPANEL_PROJECT_TOKEN >> .env
          echo ONESIGNAL_APP_ID=$ONESIGNAL_APP_ID >> .env
          echo API_BASE_URL=$API_BASE_URL >> .env
          echo GROWTHBOOK_API_KEY=$GROWTHBOOK_API_KEY >> .env
          echo GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY >> .env
          echo INTERCOM_APP_ID=$INTERCOM_APP_ID >> .env
          echo INTERCOM_ANDROID_API_KEY=$INTERCOM_ANDROID_API_KEY >> .env
          echo GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID >> .env
          echo GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET >> .env

      - name: Get Flutter packages
        script: |
          flutter packages pub get
      - name: Run build runner
        script: |
          dart run build_runner build --delete-conflicting-outputs
      - name: Patch Android app with Shorebird
        script: |
          # TODO: Don't tricky
          # Tricky Opus > build.gradle, force use NDK 27 to deal with "ERROR: Unknown host CPU architecture: arm64"
          # echo "Z3JvdXAgJ2V1LmVwbncub3B1c19mbHV0dGVyX2FuZHJvaWQnDQp2ZXJzaW9uICcxLjAnDQoNCmJ1aWxkc2NyaXB0IHsNCiAgICByZXBvc2l0b3JpZXMgew0KICAgICAgICBnb29nbGUoKQ0KICAgICAgICBtYXZlbkNlbnRyYWwoKQ0KICAgIH0NCg0KICAgIGRlcGVuZGVuY2llcyB7DQogICAgICAgIGNsYXNzcGF0aCAnY29tLmFuZHJvaWQudG9vbHMuYnVpbGQ6Z3JhZGxlOjcuMy4wJw0KICAgIH0NCn0NCg0Kcm9vdFByb2plY3QuYWxscHJvamVjdHMgew0KICAgIHJlcG9zaXRvcmllcyB7DQogICAgICAgIGdvb2dsZSgpDQogICAgICAgIG1hdmVuQ2VudHJhbCgpDQogICAgfQ0KfQ0KDQphcHBseSBwbHVnaW46ICdjb20uYW5kcm9pZC5saWJyYXJ5Jw0KDQphbmRyb2lkIHsNCiAgICBpZiAocHJvamVjdC5hbmRyb2lkLmhhc1Byb3BlcnR5KCJuYW1lc3BhY2UiKSkgew0KICAgICAgICBuYW1lc3BhY2UgJ2V1LmVwbncub3B1c19mbHV0dGVyX2FuZHJvaWQnDQogICAgfQ0KDQogICAgY29tcGlsZVNka1ZlcnNpb24gMzMNCg0KICAgIGNvbXBpbGVPcHRpb25zIHsNCiAgICAgICAgc291cmNlQ29tcGF0aWJpbGl0eSBKYXZhVmVyc2lvbi5WRVJTSU9OXzFfOA0KICAgICAgICB0YXJnZXRDb21wYXRpYmlsaXR5IEphdmFWZXJzaW9uLlZFUlNJT05fMV84DQogICAgfQ0KDQogICAgZGVmYXVsdENvbmZpZyB7DQogICAgICAgIG1pblNka1ZlcnNpb24gMTkNCiAgICB9DQogICAgZXh0ZXJuYWxOYXRpdmVCdWlsZCB7DQogICAgICAgIG5ka0J1aWxkew0KICAgICAgICAgICAgcGF0aCAiQW5kcm9pZC5tayINCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGRlcGVuZGVuY2llcyB7DQogICAgICAgIHRlc3RJbXBsZW1lbnRhdGlvbiAnanVuaXQ6anVuaXQ6NC4xMy4yJw0KICAgICAgICB0ZXN0SW1wbGVtZW50YXRpb24gJ29yZy5tb2NraXRvOm1vY2tpdG8tY29yZTo1LjAuMCcNCiAgICB9DQoNCiAgICB0ZXN0T3B0aW9ucyB7DQogICAgICAgIHVuaXRUZXN0cy5hbGwgew0KICAgICAgICAgICAgdGVzdExvZ2dpbmcgew0KICAgICAgICAgICAgICAgZXZlbnRzICJwYXNzZWQiLCAic2tpcHBlZCIsICJmYWlsZWQiLCAic3RhbmRhcmRPdXQiLCAic3RhbmRhcmRFcnJvciINCiAgICAgICAgICAgICAgIG91dHB1dHMudXBUb0RhdGVXaGVuIHtmYWxzZX0NCiAgICAgICAgICAgICAgIHNob3dTdGFuZGFyZFN0cmVhbXMgPSB0cnVlDQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQogICAgbmRrVmVyc2lvbiAnMjcuMC4xMjA3Nzk3MycNCn0NCg==" | base64 -d > "$HOME/.pub-cache/hosted/pub.dev/opus_flutter_android-3.0.1/android/build.gradle"

          # Should use bump version automatically by CI
          shorebird patch android \
            --flavor prod
    artifacts:
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - ngocthinhdp@gmail.com
          - joan@basedhardware.com
          - nik@basedhardware.com
          - mohsin.lp710@gmail.com
        notify:
          success: true
          failure: false
