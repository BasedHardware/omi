---
description: "JavaScript Node.js Express plugin patterns webhook handlers OAuth flows API integration error handling security"
globs:
  - "plugins/apps-js/**/*.js"
alwaysApply: false
references:
  - docs/doc/developer/apps/Introduction.mdx
  - plugins/apps-js/README.md
  - plugins/README.md
---

# JavaScript Plugin Patterns

## Plugin Structure

### Basic Express Server

```javascript
const express = require('express');
const app = express();

app.use(express.json());

// Webhook endpoint
app.post('/webhook/memory-created', async (req, res) => {
  const { id, content, category, user_id } = req.body;
  
  // Process memory
  console.log(`New memory: ${content}`);
  
  // Can call Omi API
  // Can trigger external actions
  
  res.json({ status: 'processed' });
});

app.listen(3000, () => {
  console.log('Plugin running on port 3000');
});
```

## Webhook Handlers

### Memory Creation Webhook

```javascript
app.post('/webhook/memory-created', async (req, res) => {
  try {
    const { id, content, category, user_id, created_at } = req.body;
    
    // Validate webhook
    if (!id || !content) {
      return res.status(400).json({ error: 'Invalid webhook data' });
    }
    
    // Process memory
    await processMemory({
      id,
      content,
      category,
      user_id,
      created_at,
    });
    
    // Can create new memories via Omi API
    // Can trigger external actions (Slack, email, etc.)
    
    res.json({ status: 'processed' });
  } catch (error) {
    console.error('Error processing memory webhook:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});
```

### Real-time Transcript Webhook

```javascript
app.post('/webhook/transcript', async (req, res) => {
  try {
    const { text, timestamp, conversation_id, user_id } = req.body;
    
    // Process transcript segment in real-time
    if (text.toLowerCase().includes('hey omi')) {
      await triggerAction();
    }
    
    // Can analyze sentiment
    // Can trigger smart home actions
    // Can provide real-time feedback
    
    res.json({ status: 'received' });
  } catch (error) {
    console.error('Error processing transcript webhook:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});
```

## Omi API Integration

### Making API Calls

```javascript
const axios = require('axios');

async function createMemory(apiKey, content, category) {
  try {
    const response = await axios.post(
      'https://api.omi.me/v1/dev/user/memories',
      {
        content,
        category,
      },
      {
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json',
        },
      }
    );
    
    return response.data;
  } catch (error) {
    console.error('Error creating memory:', error);
    throw error;
  }
}
```

### Batch Operations

```javascript
async function createMemoriesBatch(apiKey, memories) {
  try {
    const response = await axios.post(
      'https://api.omi.me/v1/dev/user/memories/batch',
      { memories },
      {
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json',
        },
      }
    );
    
    return response.data;
  } catch (error) {
    console.error('Error creating memories batch:', error);
    throw error;
  }
}
```

## Error Handling

### Webhook Error Handling

```javascript
app.post('/webhook/memory-created', async (req, res) => {
  try {
    // Process webhook
    await processWebhook(req.body);
    res.json({ status: 'processed' });
  } catch (error) {
    console.error('Webhook error:', error);
    
    // Return appropriate status code
    if (error.statusCode) {
      return res.status(error.statusCode).json({ error: error.message });
    }
    
    res.status(500).json({ error: 'Internal server error' });
  }
});
```

## Security

### Webhook Signature Verification

```javascript
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(JSON.stringify(payload))
    .digest('hex');
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}

app.post('/webhook/memory-created', express.raw({ type: 'application/json' }), (req, res) => {
  const signature = req.headers['x-omi-signature'];
  
  if (!verifyWebhookSignature(req.body, signature, process.env.WEBHOOK_SECRET)) {
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  const payload = JSON.parse(req.body);
  // Process webhook
});
```

## Best Practices

1. **Error Handling**: Always handle errors gracefully
2. **Idempotency**: Make webhooks idempotent
3. **Rate Limiting**: Implement rate limiting
4. **Logging**: Log all webhook calls
5. **Security**: Verify webhook signatures
6. **Documentation**: Document your plugin API
7. **Testing**: Test with webhook.site first

## Related Cursor Resources

### Rules
- `.cursor/rules/plugin-development.mdc` - Plugin development patterns
- `.cursor/rules/backend-api-patterns.mdc` - Backend API patterns

### Skills
- `.cursor/skills/omi-plugin-development/` - Plugin development workflows
- `.cursor/skills/omi-api-integration/` - API integration patterns

### Subagents
- `.cursor/agents/plugin-developer/` - Plugin development specialist

### Commands
- `/create-plugin` - Scaffold new plugin structure

## Related Documentation

- Plugin Development: `.cursor/rules/plugin-development.mdc`
- Plugin Introduction: `docs/doc/developer/apps/Introduction.mdx`
- Integrations: `docs/doc/developer/apps/Integrations.mdx`
