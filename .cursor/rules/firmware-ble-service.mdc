---
description: "BLE Bluetooth Low Energy service characteristics GATT notifications audio streaming packet fragmentation MTU battery device info"
globs:
  - "omi/**/*.c"
  - "omi/**/*.h"
  - "omiGlass/**/*.c"
  - "omiGlass/**/*.h"
alwaysApply: false
references:
  - docs/doc/developer/Protocol.mdx
---

# Firmware BLE Service

## BLE Service Implementation

### Audio Streaming Service

**Service UUID**: `19B10000-E8F2-537E-4F6C-D104768A1214`

**Characteristics**:
- **Audio Data** (`19B10001-E8F2-537E-4F6C-D104768A1214`): Audio stream to app
- **Codec Type** (`19B10002-E8F2-537E-4F6C-D104768A1214`): Codec identifier

### Service Definition (Zephyr)

```c
BT_GATT_SERVICE_DEFINE(audio_svc,
    BT_GATT_PRIMARY_SERVICE(BT_UUID_AUDIO_SERVICE),
    
    BT_GATT_CHARACTERISTIC(BT_UUID_AUDIO_DATA,
        BT_GATT_CHRC_READ | BT_GATT_CHRC_NOTIFY,
        BT_GATT_PERM_READ,
        read_audio_data, NULL, NULL),
    
    BT_GATT_CHARACTERISTIC(BT_UUID_CODEC_TYPE,
        BT_GATT_CHRC_READ | BT_GATT_CHRC_WRITE,
        BT_GATT_PERM_READ | BT_GATT_PERM_WRITE,
        read_codec_type, write_codec_type, NULL),
);
```

### Audio Data Notification

```c
void send_audio_notification(struct bt_conn *conn, uint8_t *data, uint16_t len) {
    struct bt_gatt_notify_params params = {0};
    
    params.attr = &audio_data_char;
    params.data = data;
    params.len = len;
    params.func = notification_sent;
    
    bt_gatt_notify_cb(conn, &params);
}
```

### Packet Fragmentation

```c
void send_audio_packet_fragmented(audio_packet_t *packet, uint16_t mtu) {
    uint16_t max_payload = mtu - 3;  // MTU - 3 byte header
    uint16_t total_size = sizeof(packet->audio_data);
    uint8_t index = 0;
    
    for (uint16_t offset = 0; offset < total_size; offset += max_payload) {
        uint16_t chunk_size = (offset + max_payload > total_size) 
            ? (total_size - offset) 
            : max_payload;
        
        uint8_t buffer[3 + chunk_size];
        
        // Header
        buffer[0] = packet->packet_number & 0xFF;
        buffer[1] = (packet->packet_number >> 8) & 0xFF;
        buffer[2] = index++;
        
        // Payload chunk
        memcpy(&buffer[3], &packet->audio_data[offset], chunk_size);
        
        // Send notification
        bt_gatt_notify(conn, &audio_char, buffer, sizeof(buffer));
    }
}
```

## Battery Service

### Standard BLE Battery Service

```c
BT_GATT_SERVICE_DEFINE(battery_svc,
    BT_GATT_PRIMARY_SERVICE(BT_UUID_BAS),
    BT_GATT_CHARACTERISTIC(BT_UUID_BAS_BATTERY_LEVEL,
        BT_GATT_CHRC_READ | BT_GATT_CHRC_NOTIFY,
        BT_GATT_PERM_READ,
        read_battery_level, NULL, NULL),
);

static uint8_t read_battery_level(struct bt_conn *conn,
                                  struct bt_gatt_attr *attr,
                                  void *buf, uint16_t len, uint16_t offset) {
    uint8_t level = get_battery_level();  // 0-100
    return bt_gatt_attr_read(conn, attr, buf, len, offset, &level, 1);
}

void notify_battery_level(struct bt_conn *conn) {
    uint8_t level = get_battery_level();
    bt_gatt_notify(conn, &battery_level_char, &level, 1);
}
```

**Note**: Battery notifications require firmware v1.5 or later.

## Device Information Service

### Standard BLE Device Information Service

```c
BT_GATT_SERVICE_DEFINE(device_info_svc,
    BT_GATT_PRIMARY_SERVICE(BT_UUID_DIS),
    
    BT_GATT_CHARACTERISTIC(BT_UUID_DIS_MANUFACTURER_NAME,
        BT_GATT_CHRC_READ,
        BT_GATT_PERM_READ,
        read_manufacturer, NULL, NULL),
    
    BT_GATT_CHARACTERISTIC(BT_UUID_DIS_MODEL_NUMBER,
        BT_GATT_CHRC_READ,
        BT_GATT_PERM_READ,
        read_model, NULL, NULL),
    
    BT_GATT_CHARACTERISTIC(BT_UUID_DIS_HARDWARE_REV,
        BT_GATT_CHRC_READ,
        BT_GATT_PERM_READ,
        read_hardware_rev, NULL, NULL),
    
    BT_GATT_CHARACTERISTIC(BT_UUID_DIS_FIRMWARE_REV,
        BT_GATT_CHRC_READ,
        BT_GATT_PERM_READ,
        read_firmware_rev, NULL, NULL),
);

static uint8_t read_manufacturer(struct bt_conn *conn,
                                 struct bt_gatt_attr *attr,
                                 void *buf, uint16_t len, uint16_t offset) {
    const char *name = "Based Hardware";
    return bt_gatt_attr_read(conn, attr, buf, len, offset, name, strlen(name));
}

static uint8_t read_model(struct bt_conn *conn,
                          struct bt_gatt_attr *attr,
                          void *buf, uint16_t len, uint16_t offset) {
    const char *model = "Omi";
    return bt_gatt_attr_read(conn, attr, buf, len, offset, model, strlen(model));
}

static uint8_t read_firmware_rev(struct bt_conn *conn,
                                 struct bt_gatt_attr *attr,
                                 void *buf, uint16_t len, uint16_t offset) {
    const char *version = "1.0.3";  // Update with actual version
    return bt_gatt_attr_read(conn, attr, buf, len, offset, version, strlen(version));
}
```

**Available since**: Firmware v1.0.3

## Connection Management

### Connection Callbacks

```c
static void connected(struct bt_conn *conn, uint8_t err) {
    if (err) {
        // Handle connection error
        return;
    }
    
    // Connection established
    // Start audio streaming
}

static void disconnected(struct bt_conn *conn, uint8_t reason) {
    // Connection lost
    // Stop audio streaming
}

BT_CONN_CB_DEFINE(conn_callbacks) = {
    .connected = connected,
    .disconnected = disconnected,
};
```

### MTU Exchange

```c
static void mtu_updated(struct bt_conn *conn, uint16_t tx, uint16_t rx) {
    // MTU negotiated
    // Adjust packet fragmentation accordingly
}

BT_GATT_CB_DEFINE(gatt_callbacks) = {
    .att_mtu_updated = mtu_updated,
};
```

## Best Practices

1. **MTU Handling**: Always check MTU and fragment packets accordingly
2. **Error Handling**: Check return values from BLE functions
3. **Connection State**: Track connection state for proper cleanup
4. **Notifications**: Use notifications for real-time data (audio, battery)
5. **Service Discovery**: Ensure all services are discoverable
6. **Version Management**: Update firmware version in DIS when releasing

## Related Documentation

**The `docs/` folder is the single source of truth for all user-facing documentation, deployed at [docs.omi.me](https://docs.omi.me/).**

- **BLE Protocol**: `docs/doc/developer/Protocol.mdx` - [View online](https://docs.omi.me/doc/developer/Protocol)
- **Firmware Compilation**: `docs/doc/developer/firmware/Compile_firmware.mdx` - [View online](https://docs.omi.me/doc/developer/firmware/Compile_firmware)
- **Hardware Docs**: `docs/doc/hardware/` - [View online](https://docs.omi.me/doc/hardware/)
- **Firmware Architecture**: `.cursor/rules/firmware-architecture.mdc`

## Related Cursor Resources

### Rules
- `.cursor/rules/firmware-architecture.mdc` - Firmware system architecture
- `.cursor/rules/firmware-audio-codecs.mdc` - Audio codec implementation
- `.cursor/rules/flutter-ble-protocol.mdc` - Flutter BLE integration

### Skills
- `.cursor/skills/omi-firmware-patterns/` - Firmware patterns including BLE
- `.cursor/skills/omi-flutter-patterns/` - Flutter BLE patterns

### Subagents
- `.cursor/agents/firmware-engineer/` - Firmware BLE specialist
- `.cursor/agents/flutter-developer/` - Flutter BLE integration specialist

### Commands
- `/flutter-setup` - Setup firmware development environment
