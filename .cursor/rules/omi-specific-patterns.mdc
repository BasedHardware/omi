---
description: "Omi-specific architecture patterns and principles that must be followed"
alwaysApply: true
references:
  - ISSUE_TRIAGE_GUIDE.MD
  - docs/doc/developer/backend/backend_deepdive.mdx
  - docs/doc/developer/backend/chat_system.mdx
  - docs/doc/developer/backend/StoringConversations.mdx
---

# Omi-Specific Patterns

This rule encodes Omi-specific knowledge about architecture, priorities, and patterns that must be understood and followed.

## Core Principle: Memory-First

**Omi is a memory-first product. The highest priority is protecting the core memory loop:**

```
Capture → Understand → Remember → Retrieve → Act
```

**If Omi fails to capture or preserve memory, nothing else matters.**

All decisions flow from this principle.

## Layer Hierarchy

Every change must be mapped to one primary layer. These layers are NOT equal - lower layers support everything above them.

### Layer Weights (from `ISSUE_TRIAGE_GUIDE.MD`)

1. **Capture** (Weight: 5) - Highest priority
   - Audio recording
   - Device pairing
   - Permissions
   - Battery stability
   - Offline capture

2. **Understand** (Weight: 4) - High priority
   - Speech-to-text
   - Language detection
   - Diarization
   - Transcription accuracy

3. **Memory** (Weight: 4) - High priority
   - Memory creation
   - Syncing
   - Storage
   - Metadata
   - Privacy boundaries

4. **Intelligence** (Weight: 3) - Medium priority
   - Summaries
   - Insights
   - Action items
   - Reasoning across memories

5. **Retrieval / Action** (Weight: 3) - Medium priority
   - Search
   - Asking Omi questions
   - Tasks
   - Exports
   - Integrations

6. **UX / Polish** (Weight: 1) - Low priority
   - UI layout
   - Animations
   - Wording

7. **Docs / Tooling** (Weight: 1) - Low priority
   - Documentation
   - Examples
   - Developer tooling

### Priority Calculation

Priority Score = (Core Layer Weight × Failure Severity) + Trust Impact + Frequency + Maintenance Leverage - Cost & Risk

**Priority Levels**:
- >= 30: P0 - Existential / must fix immediately
- 22-29: P1 - Critical
- 14-21: P2 - Important
- < 14: P3 - Backlog

## Trust Impact

**Omi is a memory product, so trust is critical.**

**Trust Impact Levels**:
- **5**: Data loss or missing memories (CRITICAL)
- **4**: Incorrect or corrupted memories (CRITICAL)
- **3**: Inconsistent behavior
- **2**: Confusing but recoverable
- **1**: No trust impact

**Rule**: Any issue involving missing or corrupted memories is always high priority.

## Architecture Understanding

### Conversation Processing Flow

**Must understand this flow before modifying conversation processing:**

1. **Audio arrives via WebSocket** (`/v4/listen`)
2. **Transcription** via Deepgram/Soniox/Speechmatics
3. **Conversation creation** in Firestore (status: "in_progress")
4. **Processing trigger** via `POST /v1/conversations` or timeout
5. **LLM extraction** of structured data:
   - Title and overview
   - Action items
   - Calendar events
   - Memories (user facts)
6. **Storage** in Firestore and Pinecone

**Key Function**: `utils/conversations/process_conversation.py::process_conversation()`

**Before modifying conversation processing**:
- Read the full flow
- Understand each step
- Test the complete flow
- Verify memory storage still works

### Module Hierarchy (Backend)

**CRITICAL**: Always follow the import hierarchy.

**Order** (lowest to highest - NEVER reverse):
1. `database/` - Data access (lowest level)
2. `utils/` - Business logic
3. `routers/` - API endpoints
4. `main.py` - Application entry

**Rules**:
- Higher-level modules import from lower-level modules
- Never import from higher levels in lower levels
- Never import from `main.py` in other modules
- Never import from `routers/` in `database/` or `utils/`

**Example violations**:
```python
# ❌ BAD - utils importing from routers
# utils/apps.py
from routers.apps import some_function  # Don't do this

# ❌ BAD - database importing from utils
# database/conversations.py
from utils.llm import extract_title  # Don't do this

# ✅ GOOD - utils importing from database
# utils/apps.py
from database.cache import get_memory_cache
from database.redis_db import r
```

## Language Settings

**Always respect user's language preferences.**

**Common mistakes**:
- Features that only work in English (#4394)
- Summaries in wrong language (#4350)
- Hardcoded English-only behavior

**How to avoid**:
- Check user's language setting
- Test with multiple languages
- Use language settings from user profile
- Don't hardcode language-specific behavior

**Example**:
```python
# ✅ GOOD - Check user language
user_language = get_user_language(uid)
transcription = transcribe(audio, language=user_language)

# ❌ BAD - Hardcoded English
transcription = transcribe(audio, language="en")
```

## Background Operation

**Features should work when app is closed/backgrounded.**

**Common mistakes**:
- Features that only work when app is open (#4355)
- Features that require specific screen to be active
- Features that break when app is backgrounded

**How to avoid**:
- Design features to work in background
- Test with app closed/backgrounded
- Use background services where appropriate
- Don't assume app is always in foreground

**Example**:
```dart
// ✅ GOOD - Works in background
void startRecording() {
  // Works even when app is backgrounded
  audioRecorder.start();
}

// ❌ BAD - Only works when app is open
void startRecording() {
  if (ModalRoute.of(context)?.isCurrent == true) {
    audioRecorder.start();  // Only works on current screen
  }
}
```

## Storage Architecture

### Firestore
- Primary database for conversations, memories, users
- Use for structured data
- Follow Firestore patterns

### Pinecone
- Vector embeddings for semantic search
- Use for memory retrieval
- Follow Pinecone patterns

### Redis
- Caching (speech profiles, enabled apps, user names)
- Use for frequently accessed data
- Follow Redis patterns

### GCS (Google Cloud Storage)
- Binary files (audio, photos, speech profiles)
- Use for large files
- Follow GCS patterns

## Triage Rules

**From `ISSUE_TRIAGE_GUIDE.MD`**:

1. **Issues are signals, not commands**: Community input is invaluable, but maintainers decide priority.
2. **Popularity does not determine urgency**: Reactions and comments do not outweigh core system health.
3. **Data loss outranks feature requests**: Any issue involving missing or corrupted memories is always high priority.
4. **Capture failures outrank intelligence improvements**: Omi must record before it can reason.

## Common Omi Patterns

### Memory Extraction

Memories are extracted from conversations using LLM:

```python
from utils.llm.conversation_processing import _extract_memories

memories = await _extract_memories(
    transcript=transcript,
    existing_memories=existing_memories,
)
```

**Categories**: personal, health, work, relationships, preferences

### Chat System Architecture

The chat system uses LangGraph for routing:

1. **Classification**: `requires_context()` determines path
2. **Simple Path**: Direct LLM response (no context needed)
3. **Agentic Path**: Full tool access with LangGraph ReAct agent
4. **Persona Path**: Persona app responses

**Key File**: `utils/retrieval/graph.py`

### Adding a Chat Tool

1. Create tool function in `utils/retrieval/tools/`
2. Use `@tool` decorator from LangChain
3. Add to tool loading in `utils/retrieval/tools/app_tools.py`
4. Tool will be available in agentic chat path

## What Not to Do

### Don't Break the Memory Loop

- ❌ Don't break memory capture
- ❌ Don't break memory storage
- ❌ Don't break memory retrieval
- ❌ Don't corrupt memories
- ❌ Don't lose memories

### Don't Violate Architecture

- ❌ Don't violate import hierarchy
- ❌ Don't break module boundaries
- ❌ Don't create circular dependencies
- ❌ Don't assume system state

### Don't Ignore User Preferences

- ❌ Don't ignore language settings
- ❌ Don't hardcode English-only behavior
- ❌ Don't ignore user preferences
- ❌ Don't assume user state

## Related Rules

- `.cursor/rules/common-mistakes.mdc` - Common mistakes to avoid
- `.cursor/rules/pre-implementation-checklist.mdc` - Pre-implementation verification
- `.cursor/rules/backend-architecture.mdc` - Backend architecture details
- `.cursor/rules/flutter-architecture.mdc` - Flutter architecture details

## Related Cursor Resources

### Skills
- `.cursor/skills/omi-backend-patterns/SKILL.md` - Backend patterns
- `.cursor/skills/omi-flutter-patterns/SKILL.md` - Flutter patterns
- `.cursor/skills/self-improvement/SKILL.md` - Learn from PRs and issues

### Documentation

**The `docs/` folder is the single source of truth for all user-facing documentation, deployed at [docs.omi.me](https://docs.omi.me/).**

- `ISSUE_TRIAGE_GUIDE.MD` - Issue prioritization guide
- `docs/doc/developer/backend/backend_deepdive.mdx` - [Backend architecture](https://docs.omi.me/doc/developer/backend/backend_deepdive)
- `docs/doc/developer/backend/chat_system.mdx` - [Chat system architecture](https://docs.omi.me/doc/developer/backend/chat_system)
- `docs/doc/developer/backend/StoringConversations.mdx` - [Data storage and flow](https://docs.omi.me/doc/developer/backend/StoringConversations)
- `docs/doc/developer/backend/transcription.mdx` - [Transcription pipeline](https://docs.omi.me/doc/developer/backend/transcription)
- `docs/INDEX.md` - [Complete documentation index](https://docs.omi.me/llms.txt)
