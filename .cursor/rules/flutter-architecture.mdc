---
description: "Flutter Dart app structure state management Provider pattern widgets pages services backend integration cross-platform iOS Android macOS Windows"
globs:
  - "app/**/*.dart"
alwaysApply: false
references:
  - docs/doc/developer/AppSetup.mdx
  - docs/doc/developer/Protocol.mdx
---

# Flutter Architecture

## App Structure

**Location**: `app/`

**Platforms**: iOS, Android, macOS, Windows

**State Management**: Provider pattern

## Directory Structure

### Core Directories

- `lib/backend/` - Backend integration (API clients, WebSocket)
- `lib/services/` - Business logic services
- `lib/providers/` - State management (Provider pattern)
- `lib/pages/` - UI screens
- `lib/widgets/` - Reusable UI components
- `lib/utils/` - Utility functions
- `lib/models/` - Data models
- `lib/l10n/` - Localization files

## State Management with Provider

### Provider Pattern

```dart
// Define provider
class ConversationProvider extends ChangeNotifier {
  List<Conversation> _conversations = [];
  bool _isLoading = false;

  List<Conversation> get conversations => _conversations;
  bool get isLoading => _isLoading;

  Future<void> loadConversations() async {
    _isLoading = true;
    notifyListeners();

    try {
      _conversations = await api.getConversations();
    } catch (e) {
      // Handle error
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }
}

// Use in widget
class ConversationsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final provider = Provider.of<ConversationProvider>(context);
    
    if (provider.isLoading) {
      return CircularProgressIndicator();
    }
    
    return ListView.builder(
      itemCount: provider.conversations.length,
      itemBuilder: (context, index) {
        return ConversationTile(provider.conversations[index]);
      },
    );
  }
}
```

### Provider Registration

```dart
// main.dart
void main() {
  runApp(
    MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => ConversationProvider()),
        ChangeNotifierProvider(create: (_) => MemoryProvider()),
        ChangeNotifierProvider(create: (_) => AuthProvider()),
        // ... other providers
      ],
      child: MyApp(),
    ),
  );
}
```

## Backend Integration

### API Client Pattern

```dart
// lib/backend/http/api/conversations.dart
class ConversationsAPI {
  final HttpClient httpClient;

  ConversationsAPI(this.httpClient);

  Future<List<Conversation>> getConversations({
    int limit = 25,
    int offset = 0,
  }) async {
    final response = await httpClient.get(
      '/v1/conversations',
      queryParameters: {
        'limit': limit,
        'offset': offset,
      },
    );
    
    return (response.data['items'] as List)
        .map((json) => Conversation.fromJson(json))
        .toList();
  }
}
```

### WebSocket Pattern

```dart
// lib/backend/http/webhooks.dart
class WebSocketClient {
  WebSocket? _socket;
  
  Future<void> connect(String uid, String language) async {
    final uri = Uri.parse('$baseUrl/v4/listen?uid=$uid&language=$language');
    _socket = await WebSocket.connect(uri.toString());
    
    _socket!.listen(
      (data) {
        // Handle incoming transcript
        onTranscriptReceived(data);
      },
      onError: (error) {
        // Handle error
      },
      onDone: () {
        // Handle disconnect
      },
    );
  }
  
  void sendAudio(List<int> audioData) {
    _socket?.add(audioData);
  }
}
```

## Localization

### Using Localization

```dart
// Always use context.l10n.keyName
Text(context.l10n.helloWorld)

// Never use hardcoded strings
Text('Hello World')  // âŒ BAD
```

### Adding New Keys

Use `jq` to add keys to ARB files (never read full files):

```bash
# Add new key
jq '.helloWorld = "Hello World"' app/lib/l10n/app_en.arb > temp.arb && mv temp.arb app/lib/l10n/app_en.arb

# Regenerate
cd app && flutter gen-l10n
```

## Platform-Specific Code

### Platform Detection

```dart
import 'package:omi/utils/platform/platform_manager.dart';

if (PlatformManager.isIOS) {
  // iOS-specific code
} else if (PlatformManager.isAndroid) {
  // Android-specific code
} else if (PlatformManager.isMacOS) {
  // macOS-specific code
} else if (PlatformManager.isWindows) {
  // Windows-specific code
}
```

### Platform-Specific Widgets

```dart
// Use base_adaptive_widget.dart for platform-specific UI
class AdaptiveButton extends BaseAdaptiveWidget {
  @override
  Widget buildIOS(BuildContext context) {
    return CupertinoButton(...);
  }
  
  @override
  Widget buildAndroid(BuildContext context) {
    return MaterialButton(...);
  }
}
```

## Error Handling

### API Error Handling

```dart
try {
  final conversations = await api.getConversations();
} on HttpException catch (e) {
  if (e.statusCode == 401) {
    // Handle unauthorized
  } else if (e.statusCode == 404) {
    // Handle not found
  }
} catch (e) {
  // Handle other errors
  logger.error('Error loading conversations: $e');
}
```

## Best Practices

1. **State Management**: Use Provider for all state
2. **Localization**: Always use `context.l10n.keyName`
3. **Error Handling**: Handle all errors gracefully
4. **Platform Support**: Test on all platforms
5. **Code Organization**: Keep related code together
6. **Widget Reusability**: Extract reusable widgets
7. **Performance**: Use const constructors where possible

## Related Documentation

**The `docs/` folder is the single source of truth for all user-facing documentation, deployed at [docs.omi.me](https://docs.omi.me/).**

- **App Setup**: `docs/doc/developer/AppSetup.mdx` - [View online](https://docs.omi.me/doc/developer/AppSetup)
- **BLE Protocol**: `docs/doc/developer/Protocol.mdx` - [View online](https://docs.omi.me/doc/developer/Protocol)
- **Flutter Localization**: `.cursor/rules/flutter-localization.mdc`

## Related Cursor Resources

### Rules
- `.cursor/rules/flutter-backend-integration.mdc` - Backend API integration
- `.cursor/rules/flutter-ble-protocol.mdc` - BLE device communication
- `.cursor/rules/flutter-localization.mdc` - Localization requirements
- `.cursor/rules/flutter-platform-specific.mdc` - Platform-specific code

### Skills
- `.cursor/skills/omi-flutter-patterns/` - Flutter patterns and workflows

### Subagents
- `.cursor/agents/flutter-developer/` - Flutter app development specialist

### Commands
- `/flutter-setup` - Setup Flutter environment
- `/flutter-test` - Run Flutter tests
- `/flutter-build` - Build Flutter app
