name: Sync Mintlify Docs Back to SDK README.md

on:
  push:
    branches:
      - '**'
    paths:
      - "docs/docs/docs/**/*.mdx"

  workflow_dispatch:

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync .mdx to README.md
        shell: bash
        run: |
          echo "üîÅ Syncing MDX files to SDK README.md..."

          declare -A files=(
            ["docs/docs/docs/developer/sdk/python.mdx"]="sdks/python/README.md"
            ["docs/docs/docs/developer/sdk/reactnative.mdx"]="sdks/react-native/README.md"
            ["docs/docs/docs/developer/sdk/swift.mdx"]="sdks/swift/README.md"
          )

          for src in "${!files[@]}"; do
            dest="${files[$src]}"
            echo "‚Üí Processing $src ‚Üí $dest"

            if [[ -f "$src" ]]; then
              # Strip frontmatter
              sed '1,/^---$/d' "$src" | sed '/^---$/d' > temp.md

              relative_depth=$(awk -F'/' '{print NF-1}' <<< "$dest")
              prefix=""
              for ((i=0; i<$relative_depth; i++)); do
                prefix+="../"
              done

              sed -i "s|](/images/|](${prefix}docs/images/|g" temp.md

              mkdir -p "$(dirname "$dest")"

              rm -f "$dest"

              # Add auto-generated banner
              {
                echo "<!--"
                echo "‚ö†Ô∏è This file is auto-generated from $src. Do not edit manually."
                echo "-->"
                echo ""
                cat temp.md
              } > "$dest"

              rm temp.md
              echo "‚úÖ Synced $src ‚Üí $dest"
            else
              echo "‚ö†Ô∏è Skipped: $src not found"
              ls -la "$(dirname "$src")"
            fi
          done

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: GitHub Action
          author_email: action@github.com
          message: "chore(docs): sync .mdx ‚Üí SDK README.md"
          add: |
            sdks/python/README.md
            sdks/react-native/README.md
            sdks/swift/README.md
