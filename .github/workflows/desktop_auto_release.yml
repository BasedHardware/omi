name: Auto Release Desktop on Main

on:
  push:
    branches: ["main"]
    paths:
      - 'desktop/**'

permissions:
  contents: write

jobs:
  tag-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next version and push tag
        run: |
          # Read major.minor from desktop/VERSION (e.g. "0.11" or "1.0")
          # To bump major/minor, edit desktop/VERSION and merge to main.
          BASE_VERSION=$(cat desktop/VERSION | tr -d '[:space:]')
          echo "Base version (from desktop/VERSION): $BASE_VERSION"

          # Find the latest released tag for this major.minor
          LATEST=$(git tag -l "v${BASE_VERSION}.*-macos" | sort -V | tail -1)

          if [ -z "$LATEST" ]; then
            # First release for this major.minor
            VERSION="${BASE_VERSION}.0"
          else
            # Increment patch: v0.11.9+11009-macos -> patch=9 -> 10 -> 0.11.10
            PATCH=$(echo "$LATEST" | sed -E "s|^v${BASE_VERSION}\\.([0-9]+)\\+[0-9]+-macos\$|\\1|")
            PATCH=$((PATCH + 1))
            VERSION="${BASE_VERSION}.${PATCH}"
          fi

          # Build number: 0.11.10 -> 11010  (each component * 1000, summed)
          BUILD_NUMBER=$(echo "$VERSION" | tr '.' '\n' | awk '{s=s*1000+$1}END{print s}')
          RELEASE_TAG="v${VERSION}+${BUILD_NUMBER}-macos"

          echo "Latest tag : ${LATEST:-none}"
          echo "New version: $VERSION"
          echo "New tag    : $RELEASE_TAG"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$RELEASE_TAG"
          git push origin "$RELEASE_TAG"
