#!/bin/bash
# Codemagic build status checker
# Usage: cm-builds [limit]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Load token from .env.local
if [ -f "$ROOT_DIR/.env.local" ]; then
  export $(grep CODEMAGIC_API_TOKEN "$ROOT_DIR/.env.local" | xargs)
fi

if [ -z "$CODEMAGIC_API_TOKEN" ]; then
  echo "Error: CODEMAGIC_API_TOKEN not set"
  echo "Add it to .env.local or export it"
  exit 1
fi

LIMIT=${1:-10}

curl -s -H "x-auth-token: $CODEMAGIC_API_TOKEN" \
  "https://api.codemagic.io/builds?limit=$LIMIT" | jq -r '
  .builds | .[] |
  "\(
    .status |
    if . == "building" then "üî® BUILDING"
    elif . == "finished" then "‚úÖ DONE    "
    elif . == "queued" then "‚è≥ QUEUED  "
    elif . == "canceled" then "‚ùå CANCELED"
    elif . == "failed" then "üí• FAILED  "
    elif . == "skipped" then "‚è≠Ô∏è  SKIPPED "
    else .
    end
  )  \((.config.name // "unknown workflow")[0:45])  (\(.branch))"'
